<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>D3 Transitions</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <style>
 	
 	</style>
</head>

<body>

	<div id="main">

	</div>
<script type="text/javascript">

	 
// load csv data
        d3.csv("./Book1.csv", d3.autoType)
            .then(function(data) {
                console.log(data);

                plotBarChart(data);
            }) 

const data = [{
    "name": "Burj Khalifa",
    "height": "350"
  },
  {
    "name": "Shanghai Tower",
    "height": "263.34"
  },
  {
    "name": "Abraj Al-Bait Clock Tower",
    "height": "254.04"
  },
  {
    "name": "Ping An Finance Centre",
    "height": "253.20"
  },
  {
    "name": "Lotte World Tower",
    "height": "230.16"
  },
  {
    "name": "Burj Khalifa 2",
    "height": "350"
  },
  {
    "name": "Shanghai Tower 2",
    "height": "263.34"
  },
  {
    "name": "Abraj Al-Bait Clock Tower 2",
    "height": "254.04"
  },
  {
    "name": "Ping An Finance Centre 2",
    "height": "253.20"
  }
]

data.forEach((d) => {
  d.height = Number(d.height)
})

const heightExtent = d3.extent(data, d => d.height)

const bars = data.map(d => d.name)

const containerWidth = 700
const containerHeight = 300
const barWidth = 16
const radius = Math.min(containerWidth / 2, containerHeight / 2) - barWidth * 4;

const y = d3.scaleLinear()
  .domain([0, heightExtent[1]])
  .range([0, radius])

const angle = d3.scaleBand()
  .domain(bars)
  .range([0, 360])
  .paddingInner(0.02)
  .paddingOuter(0)

const colourScale = d3.scaleOrdinal(d3.schemeBlues[data.length])

const svg = d3.select("#main").append("svg")
  .attr("width", containerWidth)
  .attr("height", containerHeight)

const buildings = svg.selectAll('rect').data(data)

buildings.enter().append('rect')
  .attr('x', - barWidth / 2)
  .attr('y', barWidth * 2)
  .attr('width', barWidth)
  .attr('height', (d, i) => y(d.height))
  .style('transform', (d, i) =>
    `translate(${containerWidth / 2}px, ${containerHeight / 2}px) rotate(${angle(d.name)}deg)`)
  .attr('fill', (d, i) => colourScale(d.name))

const labels = svg.selectAll('text').data(data)

labels.enter().append('text')
  .attr('x', -barWidth / 2)
  .attr('text-anchor', (d, i) => {
    const degrees = angle(d.name);
    if(10 <= degrees && degrees <= 170) { return 'end'; }
    if(190 <= degrees && degrees <= 350) { return 'start'; }
    return 'middle';
  })
  .style('transform', (d, i) => {
    const xBase = containerWidth / 2;
    const yBase = containerHeight / 2;
    
    const degrees = angle(d.name);
    const radians = (degrees + 90) / 360 * 2 * Math.PI;
    const barHeight = y(d.height) + 2.5 * barWidth;

    const yOffset = Math.sin(radians) * barHeight;
    const xOffset = Math.cos(radians) * barHeight;

    return `translate(${xBase + xOffset}px, ${yBase + yOffset}px)`;
  })
  .text((d, i) => (d.name + ' - ' + d.height + 'm'))

</script>
</body>
</html>
